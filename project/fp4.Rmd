---
title: "FP4"
author: "Erin Franke and Vivian Powell"
date: "2023-04-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Summary of Project

Group members: Erin Franke & Vivian Powell. 
Area of work: Superfund sites and PFAS in the Twin Cities. 
Description: Our project will provide a user-friendly way to learn about PFAS and superfund site data from Washington, Ramsey, and Hennepin counties provided by the MPCA.

# Research Questions

Where are superfund sites located in the Twin Cities? How have they progressed in containing harmful chemicals, specifically PFAS? What types of PFAS are most and least prominent?

According to the CDC, PFAS are a group of chemicals used to make fluoropolymer coatings and products that resist heat, oil, stains, grease, and water. They are health effects associated with PFAS including cancer, liver damage, decreased fertility, and increased risk of asthma and thyroid disease. This project aims to highlight where levels of PFAS have been detected. Given the data provided by the MPCA chose to focus on superfund sites, we look specifically at these sites and try to understand the progress being made to clean them up. 
 
# Completed work

## Libraries and Data

```{r}
library(tidyverse)
library(skimr)
library(readxl)
library(sf)
library(USAboundaries)
```

```{r, message=FALSE, warning=FALSE}
pfas <- read_xlsx("../data/Twin Cities PFAS Data Ticket WO00000021224685.xlsx", sheet=2)

counties <- us_counties(resolution = "high", states = c("Minnesota", "Wisconsin")) %>%
  st_transform(crs = 6783)
rivers <- read_sf('../data/shp_water_lakes_rivers') %>%
  st_transform(crs = 6783)
```

```{r, eval=FALSE}
threeM <- read_csv("../data/superfund_site_data/3m_chemolite.csv") %>%
  mutate(site = "3M Chemolite", county = "Washington", SYS_LOC_CODE = as.numeric(SYS_LOC_CODE))
oakdale <- read_csv("../data/superfund_site_data/oakdale.csv") %>%
  mutate(site = "3M Oakland", county = "Washington")
ashland <- read_csv("../data/superfund_site_data/ashland.csv") %>%
  mutate(site = "Ashland Oil - Park Penta", county = "Washington")
bayport <- read_csv("../data/superfund_site_data/bayport.csv") %>%
  mutate(site = "Baytown Township", county = "Washington")
lakeland <- read_csv("../data/superfund_site_data/lakeland.csv") %>%
  mutate(site = "Lakeland", county = "Washington")

lyndale55 <- read_csv("../data/superfund_site_data/66th.csv") %>%
  mutate(site = "55th St & Lyndale Ave S", county = "Hennepin")
vincent66 <- read_csv("../data/superfund_site_data/lynndale55.csv") %>%
  mutate(site = "66th St. & Vincent Ave", county = "Hennepin")
cedarServices <- read_csv("../data/superfund_site_data/cedarservices.csv") %>%
  mutate(site = "Cedar Services (MDA)", county = "Hennepin")
chemMarketing <- read_csv("../data/superfund_site_data/chemMarketing.csv") %>%
  mutate(site = "Chemical Marketing Corp of America", county = "Hennepin")
cmcHeartland <- read_csv("../data/superfund_site_data/cmcHeartland.csv") %>%
  mutate(site = "CMC Heartland Lite Yard (MDA)", county = "Hennepin")
generalMills <- read_csv("../data/superfund_site_data/generalMills.csv") %>%
  mutate(site = "General Mills/Henkel Corp. site", county = "Hennepin")
goldEagleH <- read_csv("../data/superfund_site_data/goldenEagleH.csv") %>%
  mutate(site = "Gold Eagle Cleaners", county = "Hennepin")
hmong <- read_csv("../data/superfund_site_data/hmong.csv") %>%
  mutate(site = "Hmong Shopping Center/Pilgrim Cleaners", county = "Hennepin")
minnegasco <-  read_csv("../data/superfund_site_data/minnegasco.csv") %>%
  mutate(site = "Minnegasco", county = "Hennepin")
pilgrim <- read_csv("../data/superfund_site_data/pilgrim.csv") %>%
  mutate(site = "Pilgrim Cleaner's site", county = "Hennepin")
precision <- read_csv("../data/superfund_site_data/precision.csv") %>%
  mutate(site = "Precision Plating Inc.", county = "Hennepin")
reilly <- read_csv("../data/superfund_site_data/reilly.csv") %>%
  mutate(site = "Reilly Tar", county = "Hennepin")
schloff <- read_csv("../data/superfund_site_data/schloff.csv") %>%
  mutate(site = "Schloff Chemical", county = "Hennepin")
sehennepin <- read_csv("../data/superfund_site_data/seHennepin.csv") %>%
  mutate(site = "Southeast Hennepin Area groundwater and vapor site", county = "Hennepin")
springpark <- read_csv("../data/superfund_site_data/springpark.csv") %>%
  mutate(site = "Spring Park Municipal Wells", county = "Hennepin")
saintlouis <- read_csv("../data/superfund_site_data/saintlouis.csv") %>%
  mutate(site = "St. Louis Park solvent plume", county = "Hennepin", SYS_LOC_CODE = as.numeric(SYS_LOC_CODE))
superior <- read_csv("../data/superfund_site_data/superior.csv") %>%
  mutate(site = "Superior Plating Inc.", county = "Hennepin")
tonkaMain <- read_csv("../data/superfund_site_data/tonkaMain.csv") %>%
  mutate(site = "Tonka Main Plant", county = "Hennepin")
universalPlating <- read_csv("../data/superfund_site_data/universal.csv") %>%
  mutate(site = "Universal Plating", county = "Hennepin")
whiteway <- read_csv("../data/superfund_site_data/whiteway.csv") %>%
  mutate(site = "White Way Cleaners", county = "Hennepin")

arcadeHawthrone <- read_csv("../data/superfund_site_data/arcade.csv") %>%
  mutate(site = "Arcade & Hawthrone Ave E", county = "Ramsey")
bellLumber <- read_csv("../data/superfund_site_data/bell_lumber.csv") %>%
  mutate(site = "Bell Lumber & Pole Company", county = "Ramsey")
centerville <- read_csv("../data/superfund_site_data/centerville.csv") %>%
  mutate(site = "Centerville Road Dump", county = "Ramsey")
fishHatchery <- read_csv("../data/superfund_site_data/fish_hatchery.csv") %>%
  mutate(site = "Fish Hatchery Dump", county = "Ramsey")
highway96 <- read_csv("../data/superfund_site_data/highway96.csv") %>%
  mutate(site = "Highway 96 Dump", county = "Ramsey")
macGillis <- read_csv("../data/superfund_site_data/macGillis.csv") %>%
  mutate(site = "MacGillis and Gibbs waste site", county = "Ramsey")
pigseye <- read_csv("../data/superfund_site_data/pigseye.csv") %>%
  mutate(site = "Pig's Eye Landfill", county = "Ramsey")
tcaap <- read_csv("../data/superfund_site_data/tcaap.csv") %>%
  mutate(site = "Twin Cities Army Ammunition Plant (TCAAP)", county = "Ramsey")
universityPascal <- read_csv("../data/superfund_site_data/universityPascal.csv") %>%
  mutate(site = "University Ave & Pascal St.", county = "Ramsey")

superfund <- bind_rows(arcadeHawthrone, ashland, bayport, bellLumber, cedarServices, centerville, chemMarketing, cmcHeartland, fishHatchery, generalMills, goldEagleH, highway96, hmong, lakeland, lyndale55, macGillis, minnegasco, oakdale, pigseye, pilgrim, precision, reilly, saintlouis, schloff, sehennepin, springpark, superior, tcaap, threeM, tonkaMain, universalPlating, universityPascal, vincent66, whiteway) %>%
   mutate(commonName = case_when(ANALYTE_NAME == "Perfluorobutanoic acid (PFBA)" ~ "PFBA", 
                                ANALYTE_NAME == "Perfluorooctanoic acid (PFOA)" ~ "PFOA", 
                                ANALYTE_NAME == "Perfluoropentanoic acid (PFPeA)" ~ "PFPeA",
                                ANALYTE_NAME == "Perfluorohexanoic acid (PFHxA)" ~ "PFHxA", 
                                ANALYTE_NAME == "Perfluorooctanesulfonate (PFOS)" ~ "PFOS", 
                                ANALYTE_NAME == "Perfluorohexanesulfonate (PFHxS)" ~ "PFHxS", 
                                ANALYTE_NAME == "Perfluorobutanesulfonate (PFBS)" ~ "PFBS"), 
          RESULT_NUMERIC = case_when(RESULT_UNIT == "ng/L" ~ RESULT_NUMERIC/ 1000, 
                                    TRUE ~ RESULT_NUMERIC))

save(superfund, file = "../data/superfund_site_data/superfund.rds")
```

```{r}
load("../data/superfund_site_data/superfund.rds")
```

SITES LACKING SAMPLES
Brooklyn Park Dump: Hennepin
Edina Well Field site: Hennepin
Gold Eagle Cleaners: Ramsey
Honeywell Inc: Hennepin
Hospital Linen: Ramsey
Joslyn Mfg. and Supply Co. OU1: Hennepin
Lyndale Avenue Corridor: Hennepin
MIBCO site: Hennepin
Minnetonka Blvd & Raleigh Ave: Hennepin
Pure Oil Bulk Facility: Hennepin
St. Paul Levee property: Ramsey
Valentine Clark Corp: Ramsey

## Preliminary EDA 

How many samples of our 7 preliminary types of PFAS do we have? What percent of these samples pass the detection limit?

```{r}
pfas %>%
  count(CHEMICAL_NAME, DETECT_FLAG) %>%
  pivot_wider(names_from = DETECT_FLAG, values_from = n) %>%
  mutate(percent_detect = Y/(Y+N), total = N+Y) %>%
  arrange(desc(percent_detect)) %>%
  filter(total > 5000) %>%
  mutate(commonName = c("PFBA", "PFOA", "PFPeA", "PFHxA", "PFOS", "PFHxS", "PFBS"))
```

Filter for only these seven types of PFAS.

```{r}
pfas7 <- pfas %>%
  filter(CHEMICAL_NAME %in% c("Perfluorobutanoic acid", "Perfluorooctanoic acid", "Perfluoropentanoic acid", "Perfluorohexanoic acid", "Perfluorooctane sulfonate", "Perfluorohexane sulfonate", "Perfluorobutane sulfonate")) %>%
  mutate(commonName = case_when(CHEMICAL_NAME == "Perfluorobutanoic acid" ~ "PFBA", 
                                CHEMICAL_NAME == "Perfluorooctanoic acid" ~ "PFOA", 
                                CHEMICAL_NAME == "Perfluoropentanoic acid" ~ "PFPeA",
                                CHEMICAL_NAME == "Perfluorohexanoic acid" ~ "PFHxA", 
                                CHEMICAL_NAME == "Perfluorooctane sulfonate" ~ "PFOS", 
                                CHEMICAL_NAME == "Perfluorohexane sulfonate" ~ "PFHxS", 
                                CHEMICAL_NAME == "Perfluorobutane sulfonate" ~ "PFBS")) %>%
  mutate(LOC_TYPE_2 = case_when(LOC_TYPE_2 == "Well-DOmestic" ~ "Well-Domestic", 
                                TRUE ~ LOC_TYPE_2))
```

## Understanding contamination based on sample location

This map of PFAS samples and whether or not there was detection. This includes all sample locations. 

```{r}
pfas7_sf <- st_as_sf(pfas7 %>%
                       filter(!is.na(LATITUDE), LATITUDE <45.5, LATITUDE >44.4), coords = c("LONGITUDE", "LATITUDE"), crs = 6783)

counties_cropped <- st_crop(counties, st_bbox(pfas7_sf))
pfas7 %>%
  ggplot()+
  geom_sf(data = counties_cropped, color = "navajowhite", fill = "ivory", size = 0.5)+
  geom_sf(data = pfas7_sf, size= 1, aes(color = DETECT_FLAG))+
  theme(axis.line = element_blank(),
        axis.text = element_blank(), 
        axis.ticks = element_blank())+
  labs(title = "PFAS samples in the greater Twin Cities", color = "Detection?")
```

### Rivers and Streams

Filter for PFAS that has been detected in Rivers/Streams or River/Stream Pereniel. This maps shows whether or not PFAS was detected in these samples - from a summary we learn that over 50% of samples have some level of PFAS detected. 

```{r}
sf_use_s2(FALSE)

river_stream <- pfas7 %>% 
  filter(LOC_TYPE_2 %in% c("River/Stream", "River/Stream Peren"), 
         !is.na(LATITUDE), !is.na(LONGITUDE), 
         LATITUDE > 44.671, LONGITUDE > -93.2, LONGITUDE < -92.6) 
river_stream <- st_as_sf(river_stream, coords = c("LONGITUDE", "LATITUDE"), crs = 6783)

counties_cropped <- st_crop(counties, xmin = -93.2, xmax = -92.6, ymin = 44.6, ymax = 45.02)
rivers_cropped <- st_crop(rivers, st_bbox(river_stream))

ggplot()+
  geom_sf(data = counties_cropped, color = "navajowhite", fill = "ivory", size = 0.5)+
  geom_sf(data= rivers_cropped, fill = "blue", color = "blue")+
  geom_sf(data = river_stream, size= 1, aes(color = DETECT_FLAG))+
  theme(axis.line = element_blank(),
        axis.text = element_blank(), 
        axis.ticks = element_blank())+
  labs(title = "PFAS samples from rivers/streams in the greater Twin Cities", color = "Detection?")

river_stream %>%
  count(DETECT_FLAG)
```

This map zooms on the largest part of the river to try to understand what types of PFAS are being sampled. Since many of the points overlap, a table helps us to understand that each of the seven types of PFAS has been detected in this area, with PFOA	and PFOS each having over 500 detections. 

```{r}
river_stream <- pfas7 %>% 
  filter(LOC_TYPE_2 %in% c("River/Stream", "River/Stream Peren"), 
         !is.na(LATITUDE), !is.na(LONGITUDE), 
         LATITUDE > 44.65, LATITUDE <44.85, LONGITUDE > -93, LONGITUDE < -92.8, DETECT_FLAG == "Y") 
river_stream <- st_as_sf(river_stream, coords = c("LONGITUDE", "LATITUDE"), crs = 6783)

counties_cropped <- st_crop(counties, st_bbox(river_stream))
rivers_cropped <- st_crop(rivers, st_bbox(river_stream))

ggplot()+
  geom_sf(data = counties_cropped, color = "navajowhite", fill = "ivory", size = 0.5)+
  geom_sf(data= rivers_cropped, fill = "blue", color = "blue")+
  geom_sf(data = river_stream, size= 0.9, aes(color = commonName), alpha = 0.5)+
  theme(axis.line = element_blank(),
        axis.text = element_blank(), 
        axis.ticks = element_blank())

river_stream %>%
  filter(DETECT_FLAG == "Y") %>%
  count(commonName)
```

### Wells 

Filter for PFAS samples in Domestic and Monitoring wells. PFAS in well has largely been detected in southern Washington county, though there are spots over neighboring counties where it has also been detected. 	PFBA has the most detection with over 9,000. 

```{r}
well <- pfas7 %>% 
  filter(LOC_TYPE_2 %in% c("Well-Domestic", "Well-Monitoring"), 
         !is.na(LATITUDE), !is.na(LONGITUDE), 
         LATITUDE <46, LATITUDE >44, LONGITUDE > -94.5, LONGITUDE < -92.2) 
well <- st_as_sf(well, coords = c("LONGITUDE", "LATITUDE"), crs = 6783)

counties_cropped <- st_crop(counties, st_bbox(pfas7_sf))

ggplot()+
  geom_sf(data = counties_cropped, color = "navajowhite", fill = "ivory", size = 0.5)+
  geom_sf(data = well, size= 1, aes(color = DETECT_FLAG))+
  theme(axis.line = element_blank(),
        axis.text = element_blank(), 
        axis.ticks = element_blank())+
  labs("PFAS in wells in the greater Twin Cities", color = "Detection")
  

well %>%
  filter(DETECT_FLAG == "Y") %>%
  count(commonName)
```

## Superfund sites 

Cleaning superfund data to only include samples in greater Twin Cities area. Create smaller dataset `superfund_loc_pfas` that only includes samples for PFAS. Transform both datsets to be SF ready.

```{r}
superfund_loc <- superfund %>%
  filter(!is.na(LATITUDE), !is.na(LONGITUDE), LATITUDE > 44, LATITUDE < 46, LONGITUDE < -92, LONGITUDE > -94)

superfund_loc_pfas <- superfund_loc %>%
  filter(ANALYTE_NAME %in% c("Perfluorohexanoic acid (PFHxA)", "Perfluorohexanesulfonate (PFHxS)", "Perfluorooctanesulfonate (PFOS)", "Perfluorooctanoic acid (PFOA)", "Perfluoropentanoic acid (PFPeA)", "Perfluorobutanesulfonate (PFBS)", "Perfluorobutanoic acid (PFBA)"))

superfund_loc <- st_as_sf(superfund_loc, coords = c("LONGITUDE", "LATITUDE"), crs = 6783)
superfund_loc_pfas <- st_as_sf(superfund_loc_pfas, coords = c("LONGITUDE", "LATITUDE"), crs = 6783)
```

This map shows where samples from superfund sites in Washington, Ramsey, and Hennepin county have been taken. Points are colored by superfund site. 

```{r}
counties_cropped <- st_crop(counties, xmin = -93.7, xmax=-92.6, ymin = 44.7, ymax=45.2)

ggplot()+
  geom_sf(data = counties_cropped, color = "navajowhite", fill = "ivory", size = 0.5)+
  geom_sf(data = superfund_loc, size= 0.9, aes(color = site), alpha = 0.5)+
  theme(legend.position = "none", 
        axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank())+
  labs(title = "Samples from superfund sites in Washington, Hennepin, and Ramsey Counties")
```

We now only plot samples that are specifically for PFAS in the three counties. We see Washington County is the main county with PFAS samples from superfund sites. 

```{r}
ggplot()+
  geom_sf(data = counties_cropped, color = "navajowhite", fill = "ivory", size = 0.5)+
  geom_sf(data = superfund_loc_pfas, size= 0.9, aes(color = site), alpha = 0.5)+
  theme(legend.position = "none", 
        axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank())+
  labs(title = "PFAS samples from superfund sites", subtitle = "Sites located in Hennepin, Washington, and Ramsey counties")
```

This map shows a quick zoom in on Washinton County to learn more about the superfund sites testing for PFAS located there. 

```{r}
washington <- superfund_loc_pfas %>% filter(county == "Washington")

counties_cropped <- st_crop(counties, xmin = -93.2, xmax=-92.7, ymin = 44.7, ymax=45.35)

ggplot()+
  geom_sf(data = counties_cropped, color = "navajowhite", fill = "ivory", size = 0.5)+
  geom_sf(data = washington, size= 0.9, aes(color = site), alpha = 0.5)+
  labs(title = "PFAS from superfund sites in Washington County")+
  theme(axis.line = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank())
```

# Temporal analysis

An important part of this project is understanding how PFAS detection in superfund sites has changed over the years as PFAS becomes more recognized as an issue, sampling techniques become more sophisticated, and superfund cleanup efforts take place. 

First, it's important to understand the distributions of pfas samples over time. Most samples fall between 2005-2010, and 2015-2022. There is an especially high density of samples taken between 2018 and 2022, which makes sense because PFAS is an issue of rapidly growing concern in recent years. In the second plot, the distributions over time of samples that did and did not detect PFAS are fairly similar.

```{r}
pfas_sf <- pfas %>%
  filter(!is.na(LATITUDE), !is.na(LONGITUDE)) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"),
                  crs = 4269)

ggplot(data = pfas_sf, aes(x = `SAMPLE DATE`)) +
  geom_density()

ggplot(data = pfas_sf, aes(x = `SAMPLE DATE`, fill = DETECT_FLAG)) +
  geom_density(alpha = 0.7)
```

Now, we want to create a plot in Shiny where you can select one of the 7 main PFAS and see an animation of how samples of that chemical has changed over the years in Washington county superfund sites. For this visualization, we'll use the percent of samples per location per year that detected the chemical. 

First, we need to create a list of latitudes and longitudes for the sampling sites:

```{r}
pfas_latlongs <- pfas %>% 
  filter(CHEMICAL_NAME %in% c("Perfluorobutanoic acid", "Perfluorooctanoic acid", "Perfluoropentanoic acid", "Perfluorohexanoic acid", "Perfluorooctane sulfonate", "Perfluorohexane sulfonate", "Perfluorobutane sulfonate"), LATITUDE != "NA", LONGITUDE != "NA") %>%
  group_by(`SYS LOC CODE`, LATITUDE, LONGITUDE) %>%
  summarize() %>%
  group_by(`SYS LOC CODE`) %>%
  slice_head()
```

Next, we want to create a list grouped by year, chemical, and sampling location with the percent of samples that detected the specified chemical. We'll join that to our latitude and longitude data and write it into a csv for use in the Shiny app.

```{r}
wells = c("Well",	"Well-Domestic","Well-Monitoring", "Well-Observation", "Well-Other","Well-PubWtrSub")

pfas_superfund <- pfas7 %>%
  filter(`FACILITY TYPE` == "Superfund", LOC_TYPE_2 %in% wells) %>%
  filter(COUNTY == "Washington") %>%
  mutate(detected = ifelse(DETECT_FLAG == "Y", TRUE, FALSE), year = year(`SAMPLE DATE`)) %>%
  group_by(year, commonName, `SYS LOC CODE`) %>%
  summarize(facility = unique(`FACILITY NAME`), facility_code = unique(`FACILITY CODE`), perc_detected = sum(detected)/n()) %>%
  left_join(pfas_latlongs, by = join_by(`SYS LOC CODE`)) %>%
  rename(sys_loc_code =`SYS LOC CODE`)

write.csv(pfas_superfund, "C:\\Users\\vivianpowell\\Desktop\\STAT 456\\project\\vivian-erin-456\\pfas_superfund.csv")
```

Next, we can create the shiny app. See and run the code in our repository (in the folder titled pfasTwinCities), or below:

```{r, eval = FALSE}
library(tidyverse)
library(skimr)
library(readxl)
library(sf)
library(USAboundaries)
library(shiny)
library(shinythemes)
library(lubridate)

counties <- us_counties(resolution = "high", states = c("Minnesota", "Wisconsin")) %>%
  st_transform(crs = 6783)
rivers <- read_sf('../../data/shp_water_lakes_rivers') %>%
  st_transform(crs = 6783)

pfas <- read_xlsx("../../data/Twin Cities PFAS Data Ticket WO00000021224685.xlsx", sheet=2)

pfas7 <- pfas %>%
  filter(CHEMICAL_NAME %in% c("Perfluorobutanoic acid", "Perfluorooctanoic acid", "Perfluoropentanoic acid", "Perfluorohexanoic acid", "Perfluorooctane sulfonate", "Perfluorohexane sulfonate", "Perfluorobutane sulfonate")) %>%
  mutate(commonName = case_when(CHEMICAL_NAME == "Perfluorobutanoic acid" ~ "PFBA", 
                                CHEMICAL_NAME == "Perfluorooctanoic acid" ~ "PFOA", 
                                CHEMICAL_NAME == "Perfluoropentanoic acid" ~ "PFPeA",
                                CHEMICAL_NAME == "Perfluorohexanoic acid" ~ "PFHxA", 
                                CHEMICAL_NAME == "Perfluorooctane sulfonate" ~ "PFOS", 
                                CHEMICAL_NAME == "Perfluorohexane sulfonate" ~ "PFHxS", 
                                CHEMICAL_NAME == "Perfluorobutane sulfonate" ~ "PFBS")) %>%
  mutate(LOC_TYPE_2 = case_when(LOC_TYPE_2 == "Well-DOmestic" ~ "Well-Domestic", 
                                TRUE ~ LOC_TYPE_2))

threeM <- read_csv("../../data/superfund_site_data/3m_chemolite.csv") %>%
  mutate(site = "3M Chemolite", county = "Washington", SYS_LOC_CODE = as.numeric(SYS_LOC_CODE))
oakdale <- read_csv("../../data/superfund_site_data/oakdale.csv") %>%
  mutate(site = "3M Oakland")
ashland <- read_csv("../../data/superfund_site_data/ashland.csv") %>%
  mutate(site = "Ashland Oil - Park Penta")
bayport <- read_csv("../../data/superfund_site_data/bayport.csv") %>%
  mutate(site = "Baytown Township")
lakeland <- read_csv("../../data/superfund_site_data/lakeland.csv") %>%
  mutate(site = "Lakeland")

superfund_washington <- bind_rows(threeM, oakdale, ashland, bayport, lakeland) %>%
  filter(!is.na(LATITUDE), LATITUDE > 40, LONGITUDE > -93, LONGITUDE < -91) %>%
  filter(ANALYTE_NAME %in% c("Perfluorohexanoic acid (PFHxA)", "Perfluorohexanesulfonate (PFHxS)", "Perfluorooctanesulfonate (PFOS)", "Perfluorooctanoic acid (PFOA)", "Perfluoropentanoic acid (PFPeA)", "Perfluorobutanesulfonate (PFBS)", "Perfluorobutanoic acid (PFBA)")) %>%
  mutate(commonName = case_when(ANALYTE_NAME == "Perfluorobutanoic acid (PFBA)" ~ "PFBA", 
                                ANALYTE_NAME == "Perfluorooctanoic acid (PFOA)" ~ "PFOA", 
                                ANALYTE_NAME == "Perfluoropentanoic acid (PFPeA)" ~ "PFPeA",
                                ANALYTE_NAME == "Perfluorohexanoic acid (PFHxA)" ~ "PFHxA", 
                                ANALYTE_NAME == "Perfluorooctanesulfonate (PFOS)" ~ "PFOS", 
                                ANALYTE_NAME == "Perfluorohexanesulfonate (PFHxS)" ~ "PFHxS", 
                                ANALYTE_NAME == "Perfluorobutanesulfonate (PFBS)" ~ "PFBS"), 
         RESULT_NUMERIC = case_when(RESULT_UNIT == "ng/L" ~ RESULT_NUMERIC/ 1000, 
                                    TRUE ~ RESULT_NUMERIC))


superfund_washington <- st_as_sf(superfund_washington, coords = c("LONGITUDE", "LATITUDE"), crs = 6783)

pfas_super_washington <- read_csv("../../data/pfas_superfund.csv") %>%
  filter(LATITUDE != "NA", LONGITUDE != "NA", LATITUDE <= 45.298915338179285, LATITUDE >= 44.7471734793455) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 6783)

ui <- fluidPage(theme = shinytheme("flatly"), 
                titlePanel("PFAS in Washington County Superfund sites"),
                  fluidRow(
                    column(
                    h4("Please select a PFAS to view most recent sample results"),
                    selectInput(inputId = "commonName",
                      label = "Chemical Name",
                      choices = unique(superfund_washington$commonName)),
                    width = 6
                    ),
                    column(
                    h4("Please select a PFAS to view time series"),
                    selectInput(inputId = "common_name",
                      label = "Chemical Name",
                      choices = unique(pfas_super_washington$commonName)),
                    sliderInput(
                      inputId = "year",
                      label = "Sample Year",
                      min = min(pfas_super_washington$year),
                      max = max(pfas_super_washington$year),
                      sep = "",
                      value = 2005,
                      ticks = FALSE,
                      step = 1,
                      animate = animationOptions(interval = 300, loop = TRUE, playButton = c("Play Animation"))
                    ),
                    width = 6
                    )
                  ),
                fluidRow(
                  column(
                  plotOutput(outputId = "pfasplot"), 
                  width = 6
                  ),
                  column(
                  plotOutput(outputId = "pfasplottemporal",
                             height = 600),
                  width = 6
                  )
                  ),
                fluidRow(
                  p("These data are collected by the MPCA. More information can be found at https://www.pca.state.mn.us/air-water-land-climate/cleaning-up-minnesota-superfund-sites.")
                )
                )

server <- function(input, output) {
  counties_cropped <- st_crop(counties, xmin = -93.2, xmax=-92.7, ymin = 44.7, ymax=45.35)
  output$pfasplot <- renderPlot(
      ggplot() +
      geom_sf(data = counties_cropped %>% filter(name == "Washington"), color = "navajowhite", fill = "ivory", size = 1)+
      geom_sf(data = (superfund_washington %>% filter(commonName == input$commonName, DETECT_FLAG == "Y") 
                      %>% mutate(over_limit = RESULT_NUMERIC > MIN_ACTION_LEVEL, 
                                 over_limit = case_when(is.na(over_limit) ~ FALSE, TRUE ~ over_limit))), 
              size= 0.9, aes(color = RESULT_NUMERIC), alpha = 0.5)+
        labs(color = "Detected (ug/L)", title = paste("Detected", input$commonName, "in Washington \n County Superfund sites"))+
        scale_color_gradient(low = "pink", high = "darkred")+
        theme_classic() +
        theme(axis.ticks = element_blank(), 
              axis.text = element_blank(), 
              axis.line = element_blank(),
              title = element_text(size = 20),
              legend.title = element_text(size=16),
              legend.text = element_text(size=14),
              text = element_text(family = "AppleGothic")),
      height = 600
  )
  output$pfasplottemporal <- renderPlot(
    ggplot() + 
      geom_sf(data = counties_cropped %>% filter(name == "Washington"), color = "navajowhite", fill = "ivory", size = 1)+
      geom_sf(data = (pfas_super_washington %>%
                filter(commonName == input$common_name, year == input$year)), aes(color = perc_detected)) +
      labs(color = "% Samples Above Detection Limit", title = paste(input$common_name, "over time in Washington \n County Superfund sites"))+
      scale_color_gradient(low = "pink", high = "darkred")+
      theme_classic() +
      theme(axis.ticks = element_blank(), 
            axis.text = element_blank(), 
            axis.line = element_blank(),
            title = element_text(size = 20),
            legend.title = element_text(size=16),
            legend.text = element_text(size=14),
            text = element_text(family = "AppleGothic"))
  )
}


shinyApp(ui = ui, server = server)
```

Here is a video to show the current stage of the shiny app:

<video width="320" height="240" controls>
  <source src="app.mp4" type="video/mp4">
</video>

# Plan 

https://docs.google.com/document/d/14skmjkHoX2lXDO_YfEmURdYGNTh9PMh5htJx7yQXsr4/edit

# Group member contributions

Erin: download and clean superfund site data for Washington, Hennepin, and Ramsey Counties. Create initial visualizations to understand where superfund sites are located and where PFAS has been detected in streams/rivers and wells.

Vivian: Clean general pfas dataset obtained from MPCA. Conduct exploratory analysis of PFAS over time in Washington county. Create visualizations to show change over time at superfund sites. Design, de-bug, and style Shiny app.

Joint: intermediate presentation slides and future plan.
